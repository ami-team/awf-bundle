import{h as e,b as s,c as r,e as a,w as t,d as n,t as l,j as c,n as o,k as i,l as d,m as u,i as p,r as m,p as v,o as h,q as f,u as k,T as b,F as x,g}from"./app.min.js";import{F as y}from"./z180438a1.min.js";const _={class:"card card-shadow-transition"},w={class:"card-header d-flex justify-content-between border-0 px-3 py-2"},O=n("i",{class:"bi bi-speedometer2"},null,-1),L={class:"card-body px-3 py-2"},N={class:"text-truncate text-secondary font-sans-serif lh-1"},S={class:"d-flex justify-content-around text-secondary font-sans-serif lh-1"},C=n("i",{class:"bi bi-cpu"},null,-1),D=n("i",{class:"bi bi-memory"},null,-1),F=n("i",{class:"bi bi-device-hdd"},null,-1),j={class:"form-check form-switch"},U=["id","checked","disabled"],E=["for"],K={__name:"ServerCard",props:{server:Object},emits:["setLockState"],setup:i=>(d,u)=>{const p=e("router-link");return s(),r("div",_,[a(p,{to:`/server/${i.server.name}/tasks`},{default:t((()=>[n("h5",w,[n("span",null,l(i.server.name),1),n("span",null,[n("small",null,[O,c(" "+l(i.server.nbOfRunningTasks)+" / "+l(i.server.maxNbOfRunningTasks)+" tasks",1)]),c(),n("i",{class:o("bi bi-circle-fill text-"+("UNKNOWN"===i.server.state?"secondary":"LOCKED"===i.server.state?"danger":"success"))},null,2)])])])),_:1},8,["to"]),n("div",L,[a(p,{to:`/server/${i.server.name}/tasks`},{default:t((()=>[n("p",N,l(i.server.description),1),n("p",S,[n("span",null,[C,c(" "+l(i.server.usedCPU)+" / "+l(i.server.totalCPU)+" CPUs",1)]),n("span",null,[D,c(" "+l(i.server.usedMem)+" / "+l(i.server.totalMem)+" GB",1)]),n("span",null,[F,c(" "+l(i.server.usedDisk)+" / "+l(i.server.totalDisk)+" GB",1)])])])),_:1},8,["to"]),n("div",j,[n("input",{class:"form-check-input",type:"checkbox",role:"switch",id:`${i.server.name}-lock`,checked:"LOCKED"===i.server.state,disabled:"UNKNOWN"===i.server.state,onInput:u[0]||(u[0]=e=>d.$emit("setLockState",i.server.name,e.target.checked?"LOCKED":"UNLOCKED"))},null,40,U),n("label",{class:"form-check-label",for:`${i.server.name}-lock`},l("LOCKED"===i.server.state?"Server is locked":"Server is unlocked"),9,E)])])])}},P={},T={class:"card card-shadow-transition"},$=[d('<h5 class="card-header border-0"><span class="placeholder bg-secondary rounded-5 col-12"></span></h5><div class="card-body placeholder-glow"><span class="placeholder bg-secondary rounded-5 col-8"></span><span class="placeholder bg-secondary rounded-5 col-12"></span><span class="placeholder bg-secondary rounded-5 col-6"></span></div>',2)];const M=i(P,[["render",function(e,a){return s(),r("div",T,$)}]]),R={class:"container py-2"},q={class:"d-flex justify-content-between"},W=n("h1",{class:"fw-bold"},[n("i",{class:"bi bi-hdd-stack"}),c(" Task servers ")],-1),B={key:0},G=[n("span",{class:"spinner-grow spinner-grow-sm text-light me-1",role:"status"},null,-1),n("span",{class:"spinner-grow spinner-grow-sm text-light me-1",role:"status"},null,-1),n("span",{class:"spinner-grow spinner-grow-sm text-light me-1",role:"status"},null,-1)],I=n("span",{class:"h5"}," Exclusion server ",-1),J={key:0,class:"row g-3 mb-3"},V={key:1,class:"row g-3 mb-3"},z={__name:"ListServersView",setup(e){const l=u(),c=p("toast"),i=p("mqttClient"),d=m({search:"",servers:{},isLoading:!0,exclusionServerOn:!1}),_=v((()=>Object.values(d.servers).filter((e=>e.name.toLowerCase().includes(d.search.toLowerCase())))));h((()=>{return e=this,s=null,r=function*(){i.connect((e=>{e.subscribe("ami/taskserver/ping"),e.subscribe("ami/exclusionserver/ping"),e.execute("ListTaskServers").finally((()=>{d.isLoading=!1})).then((s=>{e.jspath("..row",s.data).forEach((s=>{const r=e.jspath('.field{.@name==="id"}.$',s)[0]||"",a=e.jspath('.field{.@name==="name"}.$',s)[0]||"",t=e.jspath('.field{.@name==="description"}.$',s)[0]||"";d.servers[a]={id:r,name:a,description:t,state:"UNKNOWN",cpuNb:0,freeMem:0,usedMem:0,totalMem:0,freeDisk:0,usedDisk:0,totalDisk:0,nbOfRunningTasks:0,maxNbOfRunningTasks:0}})),e.execute("ForcePings").catch((e=>{c("error",e.message)}))})).catch((e=>{c("error",e.message)}))}),((e,s,r)=>{if("ami/taskserver/ping"===s){const e=JSON.parse(r),s=d.servers[e.server_name];s&&(s.state=e.state,s.freeCPU=(e.free_cpu/100).toFixed(1),s.usedCPU=((e.total_cpu-e.free_cpu)/100).toFixed(1),s.totalCPU=(e.total_cpu/100).toFixed(0),s.freeMem=(e.free_mem/1048576).toFixed(1),s.usedMem=((e.total_mem-e.free_mem)/1048576).toFixed(1),s.totalMem=(e.total_mem/1048576).toFixed(1),s.freeDisk=(e.free_disk/1073741824).toFixed(1),s.usedDisk=((e.total_disk-e.free_disk)/1073741824).toFixed(1),s.totalDisk=(e.total_disk/1073741824).toFixed(1),s.nbOfRunningTasks=e.nb_of_running_tasks,s.maxNbOfRunningTasks=e.max_nb_of_running_tasks)}else if("ami/exclusionserver/ping"===s){const e=JSON.parse(r);d.exclusionServerOn="ALIVE"===e.state}return!0}),null).catch((e=>{c("error",e)}))},new Promise(((a,t)=>{var n=e=>{try{c(r.next(e))}catch(s){t(s)}},l=e=>{try{c(r.throw(e))}catch(s){t(s)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,l);c((r=r.apply(e,s)).next())}));var e,s,r}));const w=e=>{d.search=e,l.push({query:{search:e}})},O=(e,s)=>{i.execute("LOCKED"===s?"LockScheduler":"UnlockScheduler",{serverName:e}).catch((e=>{c("error",e.message)}))};return(e,l)=>(s(),r("div",R,[n("div",q,[W,n("div",null,[n("span",{class:o(`badge rounded-pill text-bg-${d.exclusionServerOn?"success":"secondary"} my-1 px-3`)},[d.isLoading?(s(),r("span",B,G)):f("",!0),I],2)])]),a(k(y),{class:"pb-4",placeholder:"Filter servers...",onUpdateSearch:w}),a(b,null,{default:t((()=>[d.isLoading?(s(),r("div",J,[(s(),r(x,null,g(6,(e=>n("div",{class:"col-md-6 col-xxl-4",key:e},[a(M)]))),64))])):(s(),r("div",V,[(s(!0),r(x,null,g(_.value,(e=>(s(),r("div",{class:"col-md-6 col-xxl-4",key:e.id},[a(K,{server:e,onSetLockState:O},null,8,["server"])])))),128))]))])),_:1})]))}};export{z as default};
